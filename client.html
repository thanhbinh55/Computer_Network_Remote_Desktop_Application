<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>REMOTE_OPS // V5.2_NETSCAN</title>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;600&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    
    <style>
        /* --- 1. CORE VARIABLES --- */
        :root {
            --bg-color: #020202;
            --main-color: #00ff41; 
            --dim-color: #003b00;
            --accent-color: #00f7ff; 
            --alert-color: #ff003c; 
            --glass-bg: rgba(0, 10, 0, 0.9);
        }

        * { box-sizing: border-box; }

        body {
            font-family: 'Share Tech Mono', monospace;
            background-color: var(--bg-color);
            color: var(--main-color);
            margin: 0; padding: 0;
            height: 100vh; width: 100vw;
            overflow: hidden;
            display: flex; flex-direction: column;
        }

        /* --- 2. LAYERS --- */
        canvas#matrix-bg { position: fixed; top: 0; left: 0; z-index: 0; opacity: 0.15; pointer-events: none; }
        .scanlines {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0) 50%, rgba(0,0,0,0.2) 50%, rgba(0,0,0,0.2));
            background-size: 100% 4px;
            z-index: 9999; pointer-events: none; 
        }

        /* --- 3. UI COMPONENTS --- */
        
        /* HEADER */
        .header {
            height: 50px; display: flex; align-items: center; padding: 0 20px;
            border-bottom: 2px solid var(--main-color);
            background: rgba(0, 20, 0, 0.95);
            justify-content: space-between;
            position: relative; z-index: 100; flex-shrink: 0;
        }

        /* NETWORK SELECTOR (NEW) */
        .net-selector {
            position: relative;
            display: flex; gap: 5px;
        }
        #target-select {
            background: #000; color: var(--main-color);
            border: 1px solid var(--dim-color);
            padding: 5px; font-family: 'Share Tech Mono';
            width: 200px; outline: none;
            display: none; /* ·∫®n m·∫∑c ƒë·ªãnh, hi·ªán khi c√≥ list */
        }
        #ip {
            background: #000; border: 1px solid var(--dim-color); 
            color: var(--accent-color); padding: 8px; 
            font-family: 'Share Tech Mono'; font-size: 13px;
            width: 180px; text-align: center; outline: none;
        }

        /* GRID LAYOUT */
        .main-grid {
            display: grid;
            grid-template-columns: 280px 1fr 320px; 
            height: calc(100vh - 50px - 25px); 
            gap: 15px; padding: 15px;
            position: relative; z-index: 10;
            overflow: hidden; 
        }

        /* PANELS */
        .panel {
            background: var(--glass-bg);
            border: 1px solid var(--dim-color);
            padding: 10px; display: flex; flex-direction: column;
            position: relative; transition: all 0.3s;
            height: 100%; overflow: hidden; min-height: 0;
        }
        .panel:hover { border-color: var(--main-color); box-shadow: 0 0 15px rgba(0, 255, 65, 0.1); }
        
        .corner { position: absolute; width: 6px; height: 6px; border-color: var(--accent-color); border-style: solid; transition: 0.3s; }
        .tl { top: -1px; left: -1px; border-width: 2px 0 0 2px; }
        .tr { top: -1px; right: -1px; border-width: 2px 2px 0 0; }
        .bl { bottom: -1px; left: -1px; border-width: 0 0 2px 2px; }
        .br { bottom: -1px; right: -1px; border-width: 0 2px 2px 0; }
        .panel:hover .corner { width: 100%; height: 100%; opacity: 0.1; }

        h3 {
            margin: 0 0 10px 0; font-size: 16px; color: var(--accent-color);
            border-bottom: 1px dashed var(--dim-color); padding-bottom: 5px;
            text-transform: uppercase; letter-spacing: 1px; flex-shrink: 0;
        }
        h3::before { content: ">> "; color: var(--main-color); }

        /* BUTTONS */
        button {
            background: rgba(0, 50, 0, 0.3); border: 1px solid var(--main-color);
            color: var(--main-color); padding: 6px 12px;
            cursor: pointer; text-transform: uppercase;
            font-family: 'Share Tech Mono'; font-weight: bold; font-size: 12px;
            position: relative; overflow: hidden; transition: all 0.2s;
        }
        button:hover { background: var(--main-color); color: #000; box-shadow: 0 0 15px var(--main-color); }
        button:active { transform: scale(0.95); } 
        .btn-red { border-color: var(--alert-color); color: var(--alert-color); background: rgba(50, 0, 0, 0.3); }
        .btn-red:hover { background: var(--alert-color); color: #fff; box-shadow: 0 0 15px var(--alert-color); }
        .btn-scan { border-color: var(--accent-color); color: var(--accent-color); }
        .btn-scan:hover { background: var(--accent-color); color: #000; box-shadow: 0 0 15px var(--accent-color); }
        
        .btn-group { display: flex; gap: 5px; margin-bottom: 5px; flex-shrink: 0; }

        /* CONTENT ELEMENTS */
        .col-center { display: flex; flex-direction: column; gap: 15px; height: 100%; overflow: hidden; }
        .screen-container {
            flex-grow: 1; border: 1px solid var(--dim-color); background: #000;
            display: flex; align-items: center; justify-content: center;
            background-image: repeating-linear-gradient(0deg, transparent, transparent 1px, #001100 1px, #001100 2px);
            position: relative; overflow: hidden; min-height: 0;
        }
        img.view-area { max-width: 100%; max-height: 100%; object-fit: contain; display: block; }
        .rec-dot { position: absolute; top: 10px; right: 10px; color: red; font-size: 10px; animation: blink 1s infinite; display: none; }

        .table-wrap { flex-grow: 1; overflow-y: auto; border: 1px solid var(--dim-color); margin-bottom: 10px; min-height: 0; }
        table { width: 100%; border-collapse: collapse; font-size: 12px; }
        th { position: sticky; top: 0; background: #002200; color: var(--accent-color); text-align: left; padding: 5px; z-index: 5; }
        td { padding: 4px 5px; border-bottom: 1px solid #001100; color: #888; }
        tr:hover td { background: var(--main-color); color: #000; cursor: pointer; }

        /* TICKER */
        .ticker-wrap {
            position: fixed; bottom: 0; width: 100%; height: 25px;
            background: #000; border-top: 1px solid var(--dim-color);
            overflow: hidden; white-space: nowrap; z-index: 20;
        }
        .ticker { display: inline-block; animation: marquee 20s linear infinite; font-size: 12px; line-height: 25px; color: #555; }
        .ticker span { margin-right: 30px; }
        .ticker strong { color: var(--main-color); }
        @keyframes marquee { 0% { transform: translate(100%, 0); } 100% { transform: translate(-100%, 0); } }

        /* MISC */
        textarea { width: 100%; height: 100%; background: #000; border: none; color: var(--main-color); padding: 8px; resize: none; font-family: 'Fira Code'; font-size: 11px; outline: none; }
        #skull-art { font-family: 'Fira Code', monospace; font-size: 8px; line-height: 8px; color: var(--dim-color); text-align: center; margin: 10px 0; transition: color 0.5s; flex-shrink: 0; }
        .chart-container { width: 100%; height: 60px; border: 1px solid var(--dim-color); background: #000; margin-bottom: 10px; flex-shrink: 0; }
        canvas.chart { width: 100%; height: 100%; display: block; }
        @keyframes blink { 50% { opacity: 0; } }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: var(--dim-color); }
        ::-webkit-scrollbar-thumb:hover { background: var(--main-color); }

        /* SCAN OVERLAY */
        #scan-overlay {
            position: absolute; top: 55px; left: 20px; 
            width: 300px; background: rgba(0, 20, 0, 0.95);
            border: 1px solid var(--accent-color);
            z-index: 200; display: none;
            padding: 10px;
            box-shadow: 0 0 20px rgba(0, 247, 255, 0.2);
        }
        .scan-item {
            padding: 5px; border-bottom: 1px solid #003300;
            cursor: pointer; display: flex; justify-content: space-between;
        }
        .scan-item:hover { background: var(--accent-color); color: #000; }
        .scan-anim { animation: blink 0.5s infinite; color: var(--accent-color); }

    </style>
</head>
<body>

    <canvas id="matrix-bg"></canvas>
    <div class="scanlines"></div>

    <div class="header">
        <div style="font-size: 22px; font-weight: bold; letter-spacing: 2px;">
            REMOTE<span style="color:var(--accent-color)">OPS</span> <span style="font-size:12px; color:#555">// V5.2_NET</span>
        </div>
        
        <div class="net-selector">
            <button class="btn-scan" onclick="scanNetwork()">üì° SCAN NET</button>
            
            <select id="target-select" onchange="document.getElementById('ip').value = this.value">
                <option value="">-- SELECT TARGET --</option>
            </select>

            <input type="text" id="ip" value="ws://localhost:9010" placeholder="Target IP...">
            <button onclick="connect()">INITIALIZE_LINK</button>
            <div id="status" style="width: 100px; text-align: center; border: 1px solid #333; padding: 5px; font-size: 12px; color: #555;">OFFLINE</div>
        </div>
    </div>

    <div id="scan-overlay">
        <div style="border-bottom: 1px solid var(--accent-color); margin-bottom: 5px; padding-bottom: 5px;">
            > NETWORK_DISCOVERY <span class="scan-anim" id="scan-icon">‚óè</span>
        </div>
        <div id="scan-list">
            <div style="color: #666; font-style: italic;">Scanning subnet...</div>
        </div>
    </div>

    <div class="main-grid">
        <div class="panel">
            <div class="corner tl"></div><div class="corner tr"></div><div class="corner bl"></div><div class="corner br"></div>
            <h3>SYSTEM_STATUS</h3>
            <pre id="skull-art">
      .ed"""" """$$$$be.
    -"           ^""**$$$e.
  ."                   '$$$c
 /                      "4$$b
d  3                      $$$$
C  $  .ec.        .ec.    $$$$
9  q  d$$b.      .d$$b.   $$$P
5  q. $$P"        "T$$   $$$P
 \  ".   .e.    .e.      $$$
  \   "  $$$    $$$     $$$
   ".    "$$    $$"    "$$
            </pre>
            <div style="font-size: 10px; color: var(--accent-color); margin-bottom: 2px;">NETWORK_TRAFFIC:</div>
            <div class="chart-container"><canvas id="net-chart" class="chart"></canvas></div>
            
            <div style="margin-top: auto; flex-shrink: 0;">
                <h3 style="color: var(--alert-color);">CRITICAL_OPS</h3>
                <button class="btn-red" style="width: 100%; margin-bottom: 8px;" onclick="if(confirm('SHUTDOWN?')) send('SYSTEM', 'SHUTDOWN')">üõë SHUTDOWN TARGET</button>
                <button style="width: 100%; border-color:#666; color:#888;" onclick="if(confirm('RESTART?')) send('SYSTEM', 'RESTART')">üîÑ REBOOT SYSTEM</button>
            </div>
        </div>

        <div class="col-center">
            <div class="panel" style="flex: 2; min-height: 0;">
                <div class="corner tl"></div><div class="corner tr"></div><div class="corner bl"></div><div class="corner br"></div>
                <div style="display: flex; justify-content: space-between; flex-shrink: 0;">
                    <h3>VISUAL_FEED</h3>
                    <div class="rec-dot" id="cam-rec">‚óè REC</div>
                </div>
                <div class="btn-group">
                    <button onclick="send('WEBCAM', 'START_STREAM'); document.getElementById('cam-rec').style.display='block'">‚ñ∂ ACTIVATE</button>
                    <button class="btn-red" onclick="send('WEBCAM', 'STOP_STREAM'); document.getElementById('cam-rec').style.display='none'">‚ñ† STOP</button>
                </div>
                <div class="screen-container">
                    <img id="cam-stream" class="view-area" alt="NO SIGNAL">
                </div>
            </div>

            <div class="panel" style="flex: 1.5; min-height: 0;">
                <div class="corner tl"></div><div class="corner tr"></div><div class="corner bl"></div><div class="corner br"></div>
                <h3 style="flex-shrink: 0;">DESKTOP_INTERCEPT</h3>
                <button onclick="captureScreen()" style="width: 100%; margin-bottom: 5px; flex-shrink: 0;">[ CAPTURE FRAME ]</button>
                <div class="screen-container">
                    <img id="screen-img" class="view-area" alt="WAITING DATA">
                </div>
            </div>

            <div class="panel" style="height: 140px; min-height: 140px; flex-shrink: 0;">
                <div class="corner tl"></div><div class="corner tr"></div><div class="corner bl"></div><div class="corner br"></div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                    <h3 style="border:none; margin:0;">KEY_LOGS</h3>
                    <div class="btn-group">
                        <button class="btn-red" onclick="send('KEYBOARD', 'START')">REC</button>
                        <button onclick="send('KEYBOARD', 'STOP')">STOP</button>
                        <button onclick="document.getElementById('keylog-out').value=''">CLR</button>
                    </div>
                </div>
                <div style="border: 1px solid var(--dim-color); flex-grow: 1;">
                    <textarea id="keylog-out" readonly placeholder="> Waiting for keystrokes..."></textarea>
                </div>
            </div>
        </div>

        <div class="panel">
            <div class="corner tl"></div><div class="corner tr"></div><div class="corner bl"></div><div class="corner br"></div>
            <h3>PROCESS_MANAGER</h3>
            
            <div class="btn-group">
                <input type="text" id="proc-path" placeholder="Process Name">
                <button onclick="startProcess()">EXEC</button>
            </div>
            <div class="btn-group">
                <button onclick="send('PROCESS', 'LIST')" style="flex: 1;">‚Üª REFRESH</button>
                <input type="number" id="proc-pid" placeholder="PID" style="width: 60px; flex:none;">
                <button class="btn-red" onclick="killProcess()">KILL</button>
            </div>
            
            <div class="table-wrap" style="flex: 1;">
                <table id="proc-table">
                    <thead><tr><th>ID</th><th>NAME</th><th>TH</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>

            <h3 style="margin-top: 15px; flex-shrink: 0;">APP_REGISTRY</h3>
            <button onclick="send('APP', 'LIST')" style="width: 100%; margin-bottom: 5px; flex-shrink: 0;">SCAN REGISTRY</button>
            
            <div class="table-wrap" style="height: 150px; flex-grow: 0; flex-shrink: 0;">
                <table id="app-table">
                    <thead><tr><th>APP NAME</th><th>ACT</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="ticker-wrap">
        <div class="ticker">
            <span>[SYSTEM]: <strong>READY</strong></span>
            <span>[NET_MODE]: <strong>SCANNER_ACTIVE</strong></span>
            <span>[PORT]: <strong>9010</strong></span>
            <span>[STATUS]: <strong>WAITING FOR TARGET...</strong></span>
            <span>[MODULES]: <strong>WEBCAM, SCREEN, KEYLOG, PROCESS LOADED</strong></span>
        </div>
    </div>

<script>
    // --- 1. MATRIX EFFECT ---
    const canvas = document.getElementById('matrix-bg');
    const ctx = canvas.getContext('2d');
    function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
    window.onresize = resize; resize();
    const chars = "01"; 
    const drops = Array(Math.floor(canvas.width/14)).fill(1);
    setInterval(() => {
        ctx.fillStyle = "rgba(0, 5, 0, 0.1)"; ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = "#0f0"; ctx.font = "14px monospace";
        drops.forEach((y, i) => {
            const text = chars[Math.floor(Math.random()*chars.length)];
            ctx.fillText(text, i*14, y*14);
            if(y*14 > canvas.height && Math.random() > 0.98) drops[i] = 0;
            drops[i]++;
        });
    }, 50);

    // --- 2. CHART ANIMATION ---
    const chartCtx = document.getElementById('net-chart').getContext('2d');
    let data = Array(40).fill(30);
    setInterval(() => {
        data.shift(); data.push(Math.random() * 40 + 5);
        const w = chartCtx.canvas.width = chartCtx.canvas.clientWidth;
        const h = chartCtx.canvas.height = chartCtx.canvas.clientHeight;
        chartCtx.strokeStyle = "#00f7ff"; chartCtx.lineWidth = 1.5; chartCtx.beginPath();
        data.forEach((v, i) => { 
            const x = (i / data.length) * w;
            const y = h - v; 
            i===0 ? chartCtx.moveTo(x, y) : chartCtx.lineTo(x, y);
        });
        chartCtx.stroke();
    }, 80);

    // --- 3. LOGIC K·∫æT N·ªêI & SCAN ---
    let ws = null;
    let isWaitingForScreenshot = false;
    const REGISTRY_API = "http://localhost:3000/api/agents"; // C·ªïng Server qu·∫£n l√Ω

    // >>> H√ÄM M·ªöI: QU√âT M·∫†NG <<<
    async function scanNetwork() {
        const overlay = document.getElementById('scan-overlay');
        const list = document.getElementById('scan-list');
        const select = document.getElementById('target-select');
        
        overlay.style.display = 'block';
        list.innerHTML = '<div style="color:var(--accent-color)">> PINGING REGISTRY (PORT 3000)...</div>';

        try {
            // G·ªçi Registry Server ƒë·ªÉ l·∫•y danh s√°ch agent
            const res = await fetch(REGISTRY_API);
            const agents = await res.json();
            
            list.innerHTML = '';
            select.innerHTML = '<option value="">-- FOUND TARGETS --</option>';
            select.style.display = 'block';

            if(agents.length === 0) {
                list.innerHTML = '<div style="color:red">> NO ACTIVE AGENTS FOUND.</div>';
            }

            agents.forEach(agent => {
                // T·∫°o item trong list overlay
                const item = document.createElement('div');
                item.className = 'scan-item';
                item.innerHTML = `<span>${agent.machineId}</span> <span>${agent.ip}</span>`;
                item.onclick = () => {
                    document.getElementById('ip').value = `ws://${agent.ip}:${agent.wsPort || 9010}`;
                    overlay.style.display = 'none';
                };
                list.appendChild(item);

                // T·∫°o option trong dropdown
                const opt = document.createElement('option');
                opt.value = `ws://${agent.ip}:${agent.wsPort || 9010}`;
                opt.text = `${agent.machineId} (${agent.ip})`;
                select.appendChild(opt);
            });

            updateTicker(`SCAN COMPLETE. FOUND ${agents.length} NODES.`);

        } catch (e) {
            list.innerHTML = '<div style="color:red">> REGISTRY OFFLINE.</div><div style="color:#555; font-size:10px;">Ensure Node.js Server is running on port 3000</div>';
            updateTicker("SCAN FAILED. REGISTRY UNREACHABLE.");
            
            // T·ª± ƒë·ªông ƒë√≥ng sau 3 gi√¢y n·∫øu l·ªói
            setTimeout(() => { overlay.style.display = 'none'; }, 3000);
        }
    }

    function connect() {
        if(ws) { ws.close(); ws=null; }
        const ip = document.getElementById('ip').value;
        const btn = document.querySelector('.header button:last-of-type'); // Select n√∫t connect
        const status = document.getElementById('status');

        btn.innerText = "CONNECTING...";
        
        try {
            ws = new WebSocket(ip);
            ws.binaryType = "arraybuffer";
            ws.onopen = () => {
                status.innerText = "ONLINE"; status.style.color = "#0f0"; status.style.borderColor = "#0f0";
                btn.innerText = "DISCONNECT";
                document.getElementById('skull-art').style.color = "#0f0";
                updateTicker(`TARGET LOCKED: ${ip}`);
            };
            ws.onclose = () => {
                status.innerText = "OFFLINE"; status.style.color = "#555"; status.style.borderColor = "#555";
                btn.innerText = "INITIALIZE LINK";
                document.getElementById('skull-art').style.color = "#555";
                updateTicker("CONNECTION LOST.");
            };
            ws.onmessage = (evt) => {
                if(evt.data instanceof ArrayBuffer) {
                    const blob = new Blob([evt.data], {type: "image/jpeg"});
                    const url = URL.createObjectURL(blob);
                    if(isWaitingForScreenshot) {
                        document.getElementById('screen-img').src = url;
                        isWaitingForScreenshot = false;
                    } else {
                        document.getElementById('cam-stream').src = url;
                    }
                } else {
                    try { handleJson(JSON.parse(evt.data)); } catch(e){}
                }
            };
        } catch(e) { 
            btn.innerText = "ERROR";
            updateTicker("ERROR: INVALID TARGET ADDRESS.");
        }
    }

    function send(mod, cmd, pay={}) {
        if(!ws || ws.readyState!==1) return alert("NO CONNECTION");
        ws.send(JSON.stringify({module:mod, command:cmd, payload:pay}));
    }

    // UI Actions
    function captureScreen() { isWaitingForScreenshot=true; send('SCREEN', 'CAPTURE_BINARY'); }
    function killProcess() { const pid=document.getElementById('proc-pid').value; if(pid) send('PROCESS','KILL',{pid:parseInt(pid)}); }
    function startProcess() { const path=document.getElementById('proc-path').value; if(path) send('PROCESS','START',{path:path}); }
    
    function updateTicker(msg) {
        document.querySelector('.ticker').innerHTML += ` <span>[UPDATE]: <strong>${msg}</strong></span>`;
    }

    function handleJson(res) {
        if(res.status==='error') return updateTicker(`ERROR: ${res.message}`);
        
        if(res.module==='PROCESS' && res.command==='LIST') {
            const tb = document.querySelector('#proc-table tbody');
            tb.innerHTML = "";
            (res.data.process_list || []).slice(0, 300).forEach(p => {
                tb.innerHTML += `<tr onclick="document.getElementById('proc-pid').value='${p.pid}'"><td>${p.pid}</td><td>${p.name}</td><td>${p.threads}</td></tr>`;
            });
            updateTicker(`PROCESS LIST UPDATED: ${res.data.process_list.length} NODES.`);
        }
        else if(res.module==='APP' && res.command==='LIST') {
            const tb = document.querySelector('#app-table tbody');
            tb.innerHTML = "";
            (res.apps || []).forEach(a => {
                tb.innerHTML += `<tr><td>${a.exe}</td><td><button class="btn-red" style="padding:0 5px;" onclick="send('APP','KILL',{name:'${a.exe}'})">X</button></td></tr>`;
            });
            updateTicker("APPLICATION REGISTRY SCANNED.");
        }
        else if(res.module==='KEYBOARD') {
            const t = document.getElementById('keylog-out');
            let k = res.data.key; if(k==='[ENTER]') k='\n';
            t.value += k; t.scrollTop = t.scrollHeight;
<div class="container">
    <div class="header">
        <b>IP Server:</b> <input type="text" id="ip" value="ws://localhost:9010">
        <button class="btn-blue" onclick="connect()">üîå Connect</button>
        <span id="status" class="status disconnected">DISCONNECTED</span>
    </div>

    <div class="grid">
        <div class="panel full">
            <h3>üìπ Webcam Stream (Realtime Binary)</h3>
            <button class="btn-green" onclick="send('WEBCAM', 'START_STREAM')">‚ñ∂ Start Stream</button>
            <button class="btn-red" onclick="send('WEBCAM', 'STOP_STREAM')">‚èπ Stop Stream</button>
            <img id="cam-stream" class="view-area" alt="Webcam Stream Off">
        </div>

<div class="panel">
            <h3>‚öôÔ∏è Process Manager</h3>
            <div style="margin-bottom: 8px; border-bottom: 1px dashed #ccc; padding-bottom: 5px;">
                <input type="text" id="proc-path" placeholder="Ex: notepad.exe" style="width: 120px;">
                <button class="btn-green" onclick="startProcess()">üöÄ Start New</button>
            </div>
            
            <div style="margin-bottom: 8px;">
                <button class="btn-blue" onclick="send('PROCESS', 'LIST')">üîÑ Refresh List</button>
                <input type="number" id="proc-pid" placeholder="PID" style="width: 70px;">
                <button class="btn-red" onclick="killProcess()">‚ò†Ô∏è Kill PID</button>
            </div>

            <div class="scroll-box">
                <table id="proc-table">
                    <thead><tr><th>PID</th><th>Name</th><th>Threads</th><th>Act</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <div class="panel">
            <h3>üì¶ App Manager</h3>
            <div style="margin-bottom: 8px;">
                <button class="btn-blue" onclick="send('APP', 'LIST')">üîÑ Refresh</button>
                <input type="text" id="app-path" placeholder="Notepad" style="width: 80px;">
                <button class="btn-green" onclick="startApp()">üöÄ Start</button>
            </div>
            <div class="scroll-box">
                <table id="app-table">
                    <thead><tr><th>Name</th><th>Action</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <div class="panel">
            <h3>üì∏ Screenshot (Binary Fast)</h3>
            <button class="btn-green" onclick="captureScreen()">üì∑ Capture Screen</button>
            <img id="screen-img" class="view-area" style="max-height: 150px;" alt="Screenshot Area">
        </div>

        <div class="panel">
            <h3>‚å®Ô∏è Keylogger</h3>
            <button class="btn-red" onclick="send('KEYBOARD', 'START')">Start Hook</button>
            <button class="btn-gray" onclick="send('KEYBOARD', 'STOP')">Stop Hook</button>
            <button class="btn-blue" onclick="document.getElementById('keylog-out').value=''">Clear</button>
            <textarea id="keylog-out"></textarea>
        </div>
        
        <div class="panel full">
            <h3>üñ•Ô∏è System Power</h3>
            <button class="btn-red" onclick="if(confirm('Shutdown?')) send('SYSTEM', 'SHUTDOWN')">üõë Shutdown</button>
            <button class="btn-gray" onclick="if(confirm('Restart?')) send('SYSTEM', 'RESTART')">üîÑ Restart</button>
        </div>
    </div>

    <div id="sys-log"></div>
</div>

<script>
    let ws = null;
    const logDiv = document.getElementById('sys-log');
    
    // C·ªù quan tr·ªçng: Ph√¢n bi·ªát g√≥i binary ƒë·∫øn l√† ·∫¢nh ch·ª•p m√†n h√¨nh hay Video stream
    let isWaitingForScreenshot = false;

    function log(msg) {
        const div = document.createElement('div');
        div.innerText = `[${new Date().toLocaleTimeString()}] ${msg}`;
        logDiv.appendChild(div);
        logDiv.scrollTop = logDiv.scrollHeight;
    }

    function connect() {
        if (ws) { ws.close(); ws = null; }
        ws = new WebSocket(document.getElementById('ip').value);
        ws.binaryType = "arraybuffer"; // B·∫Øt bu·ªôc cho Binary Mode

        ws.onopen = () => {
            document.getElementById('status').className = "status connected";
            document.getElementById('status').innerText = "CONNECTED";
            log("‚úÖ WebSocket Connected");
        };
        ws.onclose = () => {
            document.getElementById('status').className = "status disconnected";
            document.getElementById('status').innerText = "DISCONNECTED";
            log("‚ùå WebSocket Disconnected");
        };

        ws.onmessage = (event) => {
            // 1. X·ª¨ L√ù D·ªÆ LI·ªÜU NH·ªä PH√ÇN (BINARY)
            if (event.data instanceof ArrayBuffer) {
                if (isWaitingForScreenshot) {
                    // N·∫øu ƒëang ƒë·ª£i Screenshot -> Hi·ªÉn th·ªã v√†o khung Screenshot
                    renderImage('screen-img', event.data);
                    isWaitingForScreenshot = false; // Reset c·ªù
                    log("üì∏ Screenshot binary received");
                } else {
                    // M·∫∑c ƒë·ªãnh l√† Stream Webcam
                    renderImage('cam-stream', event.data);
                }
                return;
            }

            // 2. X·ª¨ L√ù D·ªÆ LI·ªÜU VƒÇN B·∫¢N (JSON)
            try {
                const res = JSON.parse(event.data);
                handleResponse(res);
            } catch (e) {
                console.error("JSON Parse Error", e);
            }
        };
    }

    // Render ·∫£nh t·ª´ ArrayBuffer d√πng Blob URL (Hi·ªáu nƒÉng cao)
    let urlCache = {};
    function renderImage(elementId, buffer) {
        const blob = new Blob([buffer], { type: "image/jpeg" });
        const url = URL.createObjectURL(blob);
        const img = document.getElementById(elementId);
        
        img.onload = () => {
            if (urlCache[elementId]) URL.revokeObjectURL(urlCache[elementId]);
            urlCache[elementId] = url;
        };
        img.src = url;
    }

    // --- G·ª¨I L·ªÜNH ---
    function send(module, command, payload = {}) {
        if (!ws || ws.readyState !== 1) { alert("Check connection!"); return; }
        const msg = { module, command, payload };
        ws.send(JSON.stringify(msg));
    }

    // --- UI ACTIONS ---
    function captureScreen() {
        isWaitingForScreenshot = true; // B·∫≠t c·ªù ƒë·ª£i ·∫£nh
        send('SCREEN', 'CAPTURE_BINARY');
    }

    function killProcess() {
        const pid = document.getElementById('proc-pid').value;
        if(pid) send('PROCESS', 'KILL', { pid: parseInt(pid) });
    }
// Th√™m h√†m n√†y v√†o v√πng <script>
    function startProcess() {
        const path = document.getElementById('proc-path').value;
        if (path) {
            // G·ª≠i l·ªánh PROCESS -> START k√®m payload path
            send('PROCESS', 'START', { path: path });
        } else {
            alert("Please enter process path/name!");
        }
    }
    function startApp() {
        const path = document.getElementById('app-path').value;
        if(path) send('APP', 'START', { path: path });
    }

    // --- X·ª¨ L√ù JSON RESPONSE ---
    function handleResponse(res) {
        if (res.status === 'error') { log("‚õî " + res.message); return; }

        // PROCESS LIST
        if (res.module === 'PROCESS' && res.command === 'LIST') {
            const tbody = document.querySelector('#proc-table tbody');
            tbody.innerHTML = "";
            const list = (res.data && res.data.process_list) ? res.data.process_list : [];
            
            list.slice(0, 300).forEach(p => {
                const row = tbody.insertRow();
                row.insertCell().innerText = p.pid;
                row.insertCell().innerText = p.name;
                row.insertCell().innerText = p.threads;
                
                const btn = document.createElement('button');
                btn.innerText = "X";
                btn.className = "btn-red";
                btn.style.padding = "2px 6px";
                btn.onclick = () => { document.getElementById('proc-pid').value = p.pid; };
                row.insertCell().appendChild(btn);
            });
            log(`Loaded ${list.length} processes`);
        }

        // APP LIST
        else if (res.module === 'APP' && res.command === 'LIST') {
            const tbody = document.querySelector('#app-table tbody');
            tbody.innerHTML = "";
            (res.apps || []).forEach(app => {
                const row = tbody.insertRow();
                row.insertCell().innerText = app.exe;
                const btn = document.createElement('button');
                btn.innerText = "Kill"; 
                btn.className = "btn-red"; btn.style.fontSize = "10px";
                btn.onclick = () => send('APP', 'KILL', { name: app.exe });
                row.insertCell().appendChild(btn);
            });
        }

        // KEYLOGGER
        else if (res.module === 'KEYBOARD' && res.command === 'PRESS') {
            let k = res.data.key;
            if(k === '[ENTER]') k = '\n';
            const txt = document.getElementById('keylog-out');
            txt.value += k;
            txt.scrollTop = txt.scrollHeight;
        }
        
        else {
            log(`‚ÑπÔ∏è [${res.module}] ${res.message || 'OK'}`);
        }
    }
</script>
</body>
</html>
