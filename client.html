<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Remote PC Control - Process Manager</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f4f9; }
        .container { max-width: 1200px; margin: auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .controls { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 15px; }
        button { padding: 8px 12px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; transition: background-color 0.2s; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        .log-box { background-color: #333; color: #0f0; padding: 10px; border-radius: 4px; max-height: 150px; overflow-y: scroll; font-family: 'Courier New', monospace; margin-top: 10px; font-size: 0.8em; }
        #process-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        #process-table th, #process-table td { border: 1px solid #ddd; padding: 8px; text-align: left; font-size: 0.9em; }
        #process-table th { background-color: #f2f2f2; cursor: pointer; }

        /* üîπ NEW: khu v·ª±c hi·ªÉn th·ªã screenshot */
        #screen-wrapper {
            margin-top: 20px;
        }
        #screen-image {
            max-width: 100%;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>‚öôÔ∏è Remote Control - Process Manager</h1>
        <div class="controls">
            <button onclick="shutdownSystem()" style="background-color: #ff5733;">Shutdown System</button>
            <button onclick="restartSystem()" style="background-color: #ffc300;">Restart System</button>
        </div>
        
        <div class="controls">
            <button id="btn-connect" onclick="connectWS()">Connect/Reconnect (9001)</button>
            <button onclick="sendCommand('PROCESS', 'LIST')">1. List Processes</button>
            
            <input type="text" id="proc-path" placeholder="Path/Name (e.g., notepad.exe)" value="notepad.exe" style="flex-grow: 1; padding: 8px;">
            <button onclick="startProcess()">2. Start Process</button>

            <input type="number" id="kill-pid" placeholder="PID to Kill" style="width: 100px; padding: 8px;">
            <button onclick="killProcess()" style="background-color: #dc3545;">3. Kill PID</button>

            <!-- üîπ NEW: n√∫t ch·ª•p m√†n h√¨nh -->
            <button onclick="captureScreen()" style="background-color: #28a745;">4. Capture Screen</button>
            <button onclick="listApplications()">List Applications</button>
            <button onclick="startApplication('Calculator')">Start Calculator</button>
            <button onclick="killApplication('Calculator')">Kill Calculator</button>

            
        
        </div>

        <h3>Console Log</h3>
        <div class="log-box" id="output"></div>

        <!-- üîπ NEW: khu v·ª±c hi·ªÉn th·ªã screenshot -->
        <div id="screen-wrapper">
            <h3>Screen Capture</h3>
            <small>(·∫¢nh m·ªõi nh·∫•t ch·ª•p t·ª´ m√°y remote)</small><br>
            <img id="screen-image" alt="No screenshot yet">
        </div>

        <h3>Process List (Click on PID to Kill)</h3>
        <table id="process-table">
            <thead>
                <tr><th>PID</th><th>Name</th><th>Threads</th><th>command</th></tr>
            </thead>
            <tbody id="process-table-body">
            </tbody>
        </table>
    </div>

    <script>
        let ws = null;
        // const WS_URL = 'ws://127.0.0.1:9001'; 
        const WS_URL = 'ws://127.0.0.1:9010';
        // const WS_URL = "ws://192.168.137.1:9010";
        //const WS_URL = "ws://10.29.160.111:9010";
        // const WS_URL = "ws://192.168.88.163:9010";

        const output = document.getElementById('output');
        const screenImg = document.getElementById('screen-image'); // üîπ NEW
        
        // UTILITY FUNCTIONS
        function logStatus(message, color = 'white') {
    output.innerHTML += 
        `<pre style="color:${color}; margin:0; white-space:pre-wrap;">${message}</pre>`;
    output.scrollTop = output.scrollHeight;
}


        // 1. WEBSOCKET CONNECTION
        function connectWS(){
            if (ws && (ws.readyState === WebSocket.OPEN || ws.readyState === WebSocket.CONNECTING)) {
                logStatus('Already connected or connecting.', 'yellow');
                return;
            }
            logStatus(`Connecting to ${WS_URL}...`, 'yellow');
            ws = new WebSocket(WS_URL);

            ws.onopen = () => logStatus('Connected to server.', 'lime');
            ws.onclose = () => logStatus('Disconnected.', 'red');
            ws.onerror = (e) => logStatus('WebSocket Error: Failed to connect.', 'red');
            
            ws.onmessage = (event) => {
                try {
                    const response = JSON.parse(event.data);
                    handleServerResponse(response);
                } catch (e) {
                    logStatus('Invalid JSON received.', 'red');
                }
            };
        }

        // 2. SEND COMMAND (The new OOP structure)
        function sendCommand(module, command, params = {}) {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                logStatus('WebSocket not connected. Please connect first.', 'red');
                return;
            }
            const payload = JSON.stringify({ module: module, command: command, ...params });
            logStatus(`SENT: ${payload}`, 'cyan');
            ws.send(payload);
        }

        // 3. SPECIFIC COMMAND HANDLERS
        function startProcess() {
            const path = document.getElementById('proc-path').value;
            if (path) {
                sendCommand('PROCESS', 'START', { path: path });
            } else {
                logStatus('Process path cannot be empty.', 'red');
            }
        }

        function killProcess(pid = null) {
            const finalPid = pid || document.getElementById('kill-pid').value;
            if (finalPid) {
                sendCommand('PROCESS', 'KILL', { pid: parseInt(finalPid) });
            } else {
                logStatus('PID to kill cannot be empty.', 'red');
            }
        }

        // Ham xu ly shutdown
        function shutdownSystem() {
            sendCommand('SYSTEM', 'SHUTDOWN');
        }

        // Ham xu ly restart
        function restartSystem() {
            sendCommand('SYSTEM', 'RESTART');
        }

        // üîπ NEW: g·ª≠i l·ªánh ch·ª•p m√†n h√¨nh
        function captureScreen() {
            sendCommand('SCREEN', 'CAPTURE');
        }

        // üîπ NEW: hi·ªÉn th·ªã ·∫£nh screen t·ª´ base64
        function showScreenFromBase64(base64, format) {
            // Backend b·∫°n hi·ªán ƒëang tr·∫£ BMP_BASE64, n√™n d√πng image/bmp
            // N·∫øu sau n√†y ƒë·ªïi sang PNG th√¨ ch·ªânh mime = 'image/png'
            const mime = (format === 'PNG_BASE64' || format === 'PNG') ? 'image/png' : 'image/bmp';
            screenImg.src = `data:${mime};base64,${base64}`;
        }

        // list app
        function listApplications() {
            sendCommand('APP', 'LIST_APPS');
        }

        // start app
        function startApplication(appName) {
            sendCommand('APP', 'START_APP', { app_name: appName });
        }

        // kill app
        function killApplication(appName) {
            sendCommand('APP', 'KILL_APP', { app_name: appName });
        }


        // 4. RESPONSE HANDLER
        function handleServerResponse(response) {
    // lu√¥n log to√†n b·ªô JSON tr∆∞·ªõc
    logJSON(response, 'cyan');

    // --- SUCCESS ---
    if (response.status === 'success') {

        // PROCESS/LIST
        if (response.module === 'PROCESS' && response.command === 'LIST') {
            const list = response.data.process_list || response.data;
            displayProcesses(list);
            logStatus(`Process count = ${list.length}`, 'yellow');
        }

        // APP/LIST_APPS (sau n√†y d√πng)
        if (response.module === 'APP' && response.command === 'LIST_APPS') {
            logStatus(`Received ${response.apps.length} applications`, 'orange');
        }

        // SCREEN/CAPTURE
        if (response.module === 'SCREEN' && response.command === 'CAPTURE') {
            if (response.image_base64) {
                showScreenFromBase64(response.image_base64, response.format);
                logStatus("Screenshot updated.", "#00ffcc");
            }
        }

        // SYSTEM ACTIONS (shutdown + restart)
        if (response.module === 'SYSTEM') {
            if (response.command === 'SHUTDOWN') {
                logStatus("‚ö† System is shutting down!", "red");
            }
            if (response.command === 'RESTART') {
                logStatus("‚ö† System is restarting!", "yellow");
            }
        }
        return;
    }

    // --- ERROR ---
    if (response.status === 'error') {
        logStatus(`[ERROR] ${response.message}`, 'red');
        return;
    }

    // --- UNKNOWN ---
    logJSON(response, 'yellow');
}

function logJSON(obj, color = 'white') {
    const pretty = JSON.stringify(obj, null, 2);
    logStatus(pretty, color);
}

        // 5. UI DISPLAY
        function displayProcesses(processes) {
            const tbody = document.getElementById('process-table-body');
            tbody.innerHTML = '';
            
            // S·∫Øp x·∫øp theo t√™n
            processes.sort((a, b) => a.name.localeCompare(b.name));

            processes.forEach(p => {
                const row = tbody.insertRow();
                row.insertCell().textContent = p.pid;
                row.insertCell().textContent = p.name;
                row.insertCell().textContent = p.threads || 'N/A';
                
                const commandCell = row.insertCell();
                const killBtn = document.createElement('button');
                killBtn.textContent = 'Kill';
                killBtn.style.backgroundColor = '#dc3545';
                killBtn.onclick = () => killProcess(p.pid);
                commandCell.appendChild(killBtn);
            });
            logStatus(`Displayed ${processes.length} processes.`, 'yellow');
        }

        // Kh·ªüi t·∫°o k·∫øt n·ªëi
        connectWS(); 
    </script>
</body>
</html>
